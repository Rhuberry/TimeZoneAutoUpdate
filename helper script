`$ErrorActionPreference = "SilentlyContinue"

`$logPath = "C:\ProgramData\Microsoft\IntuneManagementExtension\Logs\TimeZoneTaskScheduler-run.log"

try { New-Item -Path (Split-Path `$logPath) -ItemType Directory -Force | Out-Null } catch {}

function Write-Log([string]`$msg) {
    "[`$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] `$msg" | Out-File -FilePath `$logPath -Append -Encoding utf8
}

try {
    `$tzBefore = (Get-TimeZone).Id
    Write-Log "Task started | TimeZone (before): `$tzBefore"

    sc.exe config tzautoupdate start= demand | Out-Null
    Write-Log "Set tzautoupdate start=demand | exit=`$LASTEXITCODE"

    sc.exe config lfsvc start= auto | Out-Null
    Write-Log "Set lfsvc start=auto | exit=`$LASTEXITCODE"

    sc.exe start lfsvc | Out-Null
    Write-Log "Start lfsvc | exit=`$LASTEXITCODE"

    Start-Sleep -Seconds 1

    sc.exe start tzautoupdate | Out-Null
    Write-Log "Start tzautoupdate | exit=`$LASTEXITCODE"

    `$tzAfter = (Get-TimeZone).Id
    Write-Log "Task finished | TimeZone (after): `$tzAfter"
} catch {
    Write-Log "ERROR: `$(`$_.Exception.Message)
